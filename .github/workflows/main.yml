name: Deploy
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Clone repo on remote machine
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: 54.233.149.212
        username: tauan
        password: 8617775759
        script: |
          cd /tmp
          sudo rm -rf  QuizGameBackend
          git clone https://github.com/TauanMartins/QuizGameBackend.git
    - name: Set permissions and deploy
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: 54.233.149.212
        username: tauan
        password: 8617775759
        script: |
          cd /tmp/QuizGameBackend
          chmod -R 777 ./
          docker-compose up -d
          docker-compose exec -T app bash -c "cp .env.example .env && \
          sed -i "s/APP_DEBUG=true/APP_DEBUG=false/g" .env && \
          sed -i "s/APP_NAME=.*/APP_NAME=QuizGameBackend/g" .env && \
          sed -i "s/APP_ENV=.*/APP_ENV=production/g" .env && \
          sed -i "s/DB_HOST=.*/DB_HOST=54.233.149.212/g" .env && \
          sed -i "s/DB_PORT=.*/DB_PORT=5432/g" .env && \
          sed -i "s/DB_DATABASE=.*/DB_DATABASE=postgres/g" .env && \
          sed -i "s/DB_USERNAME=.*/DB_USERNAME=postgres/g" .env && \
          sed -i "s/DB_SCHEMA=.*/DB_SCHEMA=public/g" .env && \
          sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=root/g" .env"
          docker-compose exec -T app bash -c "composer install && php artisan key:generate -y && php artisan migrate -y && php artisan db:seed -y"
          
